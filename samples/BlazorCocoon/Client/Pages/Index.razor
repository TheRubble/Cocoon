@page "/"

@using Microsoft.AspNetCore.WebUtilities
@using System.Threading
@inject NavigationManager _navigationManager;
@inject HttpClient _httpClient;


<h1>Hello, world!</h1>

Welcome to your new app.

<SurveyPrompt Title="How is Blazor working for you?" />

@if (sessionSet)
{
    <text>Session is set : </text><span id="cocoonSessionSet">@sessionText</span>
}
else
{
    <text>Waiting for the session to be set.</text>
}


@code{

    protected bool sessionSet;
    protected string sessionText;

    protected override async Task OnInitializedAsync()
    {
        var uri = _navigationManager.ToAbsoluteUri(_navigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("id", out var id))
        {
            var response = await _httpClient.PostAsync("http://localhost:5000/_cocoon/session", new FormUrlEncodedContent(new List<KeyValuePair<string, string>> { new("id", "CocoonSessionShare"), new("value", id) }));
            sessionText = response.StatusCode.ToString();
            sessionSet = true;
        }
        await base.OnInitializedAsync();
    }
}